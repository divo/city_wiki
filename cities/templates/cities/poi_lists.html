{% extends "base.html" %}

{% block content %}
<style>
    .list-container {
        margin-top: 2em;
    }
    .poi-list {
        background: #f8f9fa;
        padding: 1em;
        margin-bottom: 1em;
        border-radius: 4px;
        border: 1px solid #dee2e6;
    }
    .poi-list h3 {
        margin-top: 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .poi-list ul {
        list-style: none;
        padding-left: 0;
    }
    .poi-list li {
        padding: 0.5em 0;
        border-bottom: 1px solid #dee2e6;
    }
    .poi-list li:last-child {
        border-bottom: none;
    }
    .list-meta {
        color: #6c757d;
        font-size: 0.9em;
        margin-top: 0.5em;
    }
    .delete-btn {
        background: #dc3545;
        color: white;
        border: none;
        padding: 4px 8px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.9em;
    }
    .delete-btn:hover {
        background: #c82333;
    }
    .poi-image {
        max-width: 100px;
        max-height: 100px;
        object-fit: cover;
        border-radius: 4px;
        margin-right: 10px;
    }
    .poi-image-container {
        display: inline-flex;
        flex-direction: column;
        align-items: center;
        margin-right: 10px;
        vertical-align: middle;
    }
    .poi-image {
        max-width: 100px;
        max-height: 100px;
        object-fit: cover;
        border-radius: 4px;
        margin-bottom: 5px;
        vertical-align: middle;
    }
    .delete-image-btn {
        background: #dc3545;
        color: white;
        border: none;
        padding: 2px 6px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.8em;
    }
    .delete-image-btn:hover {
        background: #c82333;
    }
    td {
        vertical-align: middle !important;
    }
    /* New styles for table rows */
    .table {
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    .table thead th {
        background-color: #f1f3f5;
        border-bottom: 2px solid #dee2e6;
        padding: 12px;
        font-weight: 600;
    }
    .table tbody tr {
        transition: background-color 0.2s ease;
    }
    .table tbody tr:nth-child(even) {
        background-color: #f8f9fa;
    }
    .table tbody tr:hover {
        background-color: #e9ecef;
    }
    .table td {
        padding: 12px;
        border: 1px solid #dee2e6;
    }
    .btn-primary {
        transition: all 0.2s ease;
    }
    .btn-primary:not(:disabled):hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
</style>

<div class="container">
    <h2>Generated Lists for {{ city.name }}</h2>
    
    <div class="list-container">
        {% if poi_lists %}
            {% for list in poi_lists %}
                <div class="poi-list">
                    <h3>
                        <span>{{ list.title }}</span>
                        <button onclick="deleteList({{ list.id }}, '{{ list.title|escapejs }}')" class="delete-btn">Delete</button>
                    </h3>
                    <table class="table table-bordered">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Category</th>
                                <th>District</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for poi in list.pois.all %}
                                <tr>
                                    <td>
                                        <div style="display: flex; align-items: center;">
                                            {% if poi.image_url %}
                                                <div class="poi-image-container">
                                                    <img src="{{ poi.image_url }}" class="poi-image" alt="{{ poi.name }}">
                                                    <button class="delete-image-btn" onclick="deleteImage({{ poi.id }}, this)">Delete Image</button>
                                                </div>
                                            {% endif %}
                                            {{ poi.name }}
                                        </div>
                                    </td>
                                    <td>{{ poi.get_category_display }}</td>
                                    <td>{{ poi.district.name|default:"Main City" }}</td>
                                    <td>
                                        <button class="btn btn-sm btn-primary fetch-image-btn" 
                                                data-poi-id="{{ poi.id }}"
                                                {% if poi.image_url %}disabled{% endif %}>
                                            {% if poi.image_url %}
                                                Image Found
                                            {% else %}
                                                Fetch Image
                                            {% endif %}
                                        </button>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    <div class="list-meta">
                        Created: {{ list.created_at|date:"F j, Y" }}
                    </div>
                </div>
            {% endfor %}
        {% else %}
            <p>No lists have been generated yet.</p>
        {% endif %}
    </div>
</div>

<script>
function deleteList(listId, listTitle) {
    if (confirm(`Are you sure you want to delete the list "${listTitle}"?`)) {
        fetch(`/city/{{ city.name }}/lists/${listId}/delete/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                window.location.reload();
            } else {
                alert('Error deleting list: ' + data.message);
            }
        })
        .catch(error => {
            alert('Error deleting list: ' + error);
        });
    }
}

document.querySelectorAll('.fetch-image-btn').forEach(button => {
    button.addEventListener('click', async function() {
        const poiId = this.dataset.poiId;
        const row = this.closest('tr');
        this.disabled = true;
        this.textContent = 'Fetching...';
        
        try {
            const response = await fetch(`/city/{{ city.name }}/poi/${poiId}/fetch_image/`, {
                method: 'POST'
            });
            
            const data = await response.json();
            
            if (data.status === 'success') {
                this.textContent = 'Image Found';
                // Create image container
                const container = document.createElement('div');
                container.className = 'poi-image-container';
                
                // Create and add image
                const img = document.createElement('img');
                img.src = data.image_url;
                img.className = 'poi-image';
                container.appendChild(img);
                
                // Create and add delete button
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-image-btn';
                deleteBtn.textContent = 'Delete Image';
                deleteBtn.onclick = () => deleteImage(poiId, container, this);
                container.appendChild(deleteBtn);
                
                // Add container to the cell
                const nameCell = row.querySelector('td:first-child');
                nameCell.insertBefore(container, nameCell.firstChild);
            } else {
                this.textContent = 'Failed';
                this.disabled = false;
            }
        } catch (error) {
            this.textContent = 'Error';
            this.disabled = false;
            console.error('Error fetching image:', error);
        }
    });
});

async function deleteImage(poiId, container, fetchButton) {
    if (confirm('Are you sure you want to delete this image?')) {
        try {
            const response = await fetch(`/city/{{ city.name }}/poi/${poiId}/delete_image/`, {
                method: 'POST'
            });
            
            const data = await response.json();
            
            if (data.status === 'success') {
                container.remove();
                fetchButton.disabled = false;
                fetchButton.textContent = 'Fetch Image';
            } else {
                alert('Error deleting image: ' + data.message);
            }
        } catch (error) {
            alert('Error deleting image: ' + error);
        }
    }
}
</script>
{% endblock %} 