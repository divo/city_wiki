{% extends "base.html" %}

{% block content %}
<style>
    .container {
        max-width: 800px;
        margin: 2rem auto;
    }
    
    .input-container {
        margin-bottom: 2rem;
    }
    
    .select-container {
        margin-bottom: 1rem;
    }
    
    .select-container select {
        width: 100%;
        padding: 0.5rem;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        margin-top: 0.25rem;
    }
    
    .input-container textarea {
        width: 100%;
        padding: 0.5rem;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        min-height: 150px;
        resize: vertical;
    }
    
    .output-container {
        margin-top: 2rem;
        display: none;
    }
    
    .output-text {
        padding: 1rem;
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        white-space: pre-wrap;
    }
    
    .loading {
        display: none;
        margin: 1rem 0;
        color: #6c757d;
    }
    
    .spinner-border {
        width: 1rem;
        height: 1rem;
        margin-left: 0.5rem;
    }
</style>

<div class="container">
    <h2>Edit Content</h2>
    <p class="text-muted">Select a city and POI list, then enter text to reword.</p>
    
    <div class="select-container">
        <label for="citySelect">City:</label>
        <select id="citySelect" class="form-control">
            <option value="">Select a city...</option>
            {% for city in cities %}
            <option value="{{ city.id }}">{{ city.name }}</option>
            {% endfor %}
        </select>
    </div>
    
    <div class="select-container">
        <label for="poiListSelect">POI List:</label>
        <select id="poiListSelect" class="form-control" disabled>
            <option value="">Select a POI list...</option>
        </select>
    </div>
    
    <form id="rewordForm" class="mb-4">
        {% csrf_token %}
        <div class="input-container">
            <label for="textInput">Text to reword:</label>
            <textarea 
                class="form-control" 
                id="textInput" 
                rows="6" 
                required 
                placeholder="Enter your text here..."></textarea>
        </div>
        <button type="submit" class="btn btn-primary" id="submitBtn">
            Reword Text
            <div class="spinner-border spinner-border-sm d-none" role="status" id="loading">
                <span class="sr-only">Loading...</span>
            </div>
        </button>
    </form>
    
    <div class="output-container" id="outputContainer">
        <h4>Reworded Version:</h4>
        <div class="output-text" id="outputText"></div>
    </div>
</div>

<script>
// Store POI lists data
const cityData = JSON.parse("{{ city_data_json|escapejs }}");

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Update POI lists when city is selected
document.getElementById('citySelect').addEventListener('change', function(e) {
    const cityId = e.target.value;
    const poiListSelect = document.getElementById('poiListSelect');
    
    // Reset and disable POI list select if no city selected
    if (!cityId) {
        poiListSelect.innerHTML = '<option value="">Select a POI list...</option>';
        poiListSelect.disabled = true;
        return;
    }
    
    // Find selected city's POI lists
    const city = cityData.find(c => c.id === parseInt(cityId));
    if (!city) return;
    
    // Update POI list options
    poiListSelect.innerHTML = '<option value="">Select a POI list...</option>';
    city.poi_lists.forEach(list => {
        const option = document.createElement('option');
        option.value = list.id;
        option.textContent = list.title;
        poiListSelect.appendChild(option);
    });
    
    poiListSelect.disabled = false;
});

document.getElementById('rewordForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const input = document.getElementById('textInput');
    const text = input.value.trim();
    const button = document.getElementById('submitBtn');
    const loading = document.getElementById('loading');
    const outputContainer = document.getElementById('outputContainer');
    const outputText = document.getElementById('outputText');
    
    if (!text) return;
    
    // Reset UI
    button.disabled = true;
    loading.classList.remove('d-none');
    
    try {
        const response = await fetch('/generate/reword/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: `text=${encodeURIComponent(text)}`
        });
        
        const data = await response.json();
        
        if (data.content) {
            outputText.textContent = data.content;
            outputContainer.style.display = 'block';
        } else if (data.message) {
            outputText.textContent = 'Error: ' + data.message;
            outputContainer.style.display = 'block';
        }
    } catch (error) {
        outputText.textContent = 'Error: ' + error.message;
        outputContainer.style.display = 'block';
    } finally {
        button.disabled = false;
        loading.classList.add('d-none');
    }
});
</script>
{% endblock %} 