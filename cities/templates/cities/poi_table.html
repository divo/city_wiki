{% if pois %}
    <style>
        .table-responsive {
            margin: 0 -15px;  /* Negative margin to break out of container padding */
            width: calc(100% + 30px);  /* Compensate for negative margin */
        }
        
        .poi-table {
            width: 100%;
            min-width: 1400px;  /* Ensure table has a good minimum width */
            margin-bottom: 1rem;
            border-collapse: collapse;
        }

        .poi-table td {
            padding: 8px;
            vertical-align: top;
            border-top: 1px solid #dee2e6;
            max-width: 300px;  /* Prevent any column from getting too wide */
            word-wrap: break-word;  /* Allow long words to break */
        }

        .poi-table th {
            padding: 12px 8px;
            border-bottom: 2px solid #dee2e6;
            background-color: #f8f9fa;
            white-space: nowrap;  /* Keep headers on one line */
        }

        /* Column specific widths */
        .poi-table td:nth-child(1) { width: 12%; }  /* Name */
        .poi-table td:nth-child(2) { width: 5%; }   /* Rank */
        .poi-table td:nth-child(3) { width: 8%; }   /* Sub-category */
        .poi-table td:nth-child(4) { width: 8%; }   /* District */
        .poi-table td:nth-child(5) { width: 20%; }  /* Description */
        .poi-table td:nth-child(6) { width: 8%; }   /* Coords */
        .poi-table td:nth-child(7) { width: 10%; }  /* Address */
        .poi-table td:nth-child(8) { width: 7%; }   /* Contact */
        .poi-table td:nth-child(9) { width: 8%; }   /* Hours */
        .poi-table td:nth-child(10) { width: 7%; }  /* Website */
        .poi-table td:nth-child(11) { width: 7%; }  /* Created at */
        
        .btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
            line-height: 1.5;
            border-radius: 0.2rem;
        }
        
        .btn-info {
            color: #fff;
            background-color: #17a2b8;
            border-color: #17a2b8;
            text-decoration: none;
        }
        
        .btn-info:hover {
            color: #fff;
            background-color: #138496;
            border-color: #117a8b;
        }

        .empty-cell {
            background-color: #ffebee;
        }

        /* Search input styles */
        .column-search {
            width: 100%;
            padding: 4px 8px;
            margin: 4px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9em;
        }

        .column-search:focus {
            outline: none;
            border-color: #17a2b8;
            box-shadow: 0 0 0 2px rgba(23, 162, 184, 0.25);
        }

        /* Hide rows that don't match search */
        tr.hidden {
            display: none;
        }
    </style>

    <div class="table-responsive">
        <table class="poi-table">
            <thead>
                <tr>
                    <th>
                        <a href="?sort=name&dir={% if sort_by == 'name' and sort_dir == 'asc' %}desc{% else %}asc{% endif %}{% if max_rank %}&max_rank={{ max_rank }}{% endif %}{% if selected_district %}&district={{ selected_district }}{% endif %}">
                            Name {% if sort_by == 'name' %}{% if sort_dir == 'asc' %}↑{% else %}↓{% endif %}{% endif %}
                        </a>
                        <input type="text" class="column-search" data-column="0" placeholder="Search names...">
                    </th>
                    <th>
                        <a href="?sort=rank&dir={% if sort_by == 'rank' and sort_dir == 'asc' %}desc{% else %}asc{% endif %}{% if max_rank %}&max_rank={{ max_rank }}{% endif %}{% if selected_district %}&district={{ selected_district }}{% endif %}">
                            Rank {% if sort_by == 'rank' %}{% if sort_dir == 'asc' %}↑{% else %}↓{% endif %}{% endif %}
                        </a>
                        <input type="text" class="column-search" data-column="1" placeholder="Search rank...">
                    </th>
                    <th>
                        <a href="?sort=sub_category&dir={% if sort_by == 'sub_category' and sort_dir == 'asc' %}desc{% else %}asc{% endif %}{% if max_rank %}&max_rank={{ max_rank }}{% endif %}{% if selected_district %}&district={{ selected_district }}{% endif %}">
                            Sub-category {% if sort_by == 'sub_category' %}{% if sort_dir == 'asc' %}↑{% else %}↓{% endif %}{% endif %}
                        </a>
                        <input type="text" class="column-search" data-column="2" placeholder="Search sub-categories...">
                    </th>
                    <th>
                        <a href="?sort=district&dir={% if sort_by == 'district' and sort_dir == 'asc' %}desc{% else %}asc{% endif %}{% if max_rank %}&max_rank={{ max_rank }}{% endif %}{% if selected_district %}&district={{ selected_district }}{% endif %}">
                            District {% if sort_by == 'district' %}{% if sort_dir == 'asc' %}↑{% else %}↓{% endif %}{% endif %}
                        </a>
                        <input type="text" class="column-search" data-column="3" placeholder="Search districts...">
                    </th>
                    <th>
                        <a href="?sort=description&dir={% if sort_by == 'description' and sort_dir == 'asc' %}desc{% else %}asc{% endif %}{% if max_rank %}&max_rank={{ max_rank }}{% endif %}{% if selected_district %}&district={{ selected_district }}{% endif %}">
                            Description {% if sort_by == 'description' %}{% if sort_dir == 'asc' %}↑{% else %}↓{% endif %}{% endif %}
                        </a>
                        <input type="text" class="column-search" data-column="4" placeholder="Search descriptions...">
                    </th>
                    <th>
                        Coords
                        <input type="text" class="column-search" data-column="5" placeholder="Search coordinates...">
                    </th>
                    <th>
                        <a href="?sort=address&dir={% if sort_by == 'address' and sort_dir == 'asc' %}desc{% else %}asc{% endif %}{% if max_rank %}&max_rank={{ max_rank }}{% endif %}{% if selected_district %}&district={{ selected_district }}{% endif %}">
                            Address {% if sort_by == 'address' %}{% if sort_dir == 'asc' %}↑{% else %}↓{% endif %}{% endif %}
                        </a>
                        <input type="text" class="column-search" data-column="6" placeholder="Search addresses...">
                    </th>
                    <th>
                        <a href="?sort=phone&dir={% if sort_by == 'phone' and sort_dir == 'asc' %}desc{% else %}asc{% endif %}{% if max_rank %}&max_rank={{ max_rank }}{% endif %}{% if selected_district %}&district={{ selected_district }}{% endif %}">
                            Contact {% if sort_by == 'phone' %}{% if sort_dir == 'asc' %}↑{% else %}↓{% endif %}{% endif %}
                        </a>
                        <input type="text" class="column-search" data-column="7" placeholder="Search contacts...">
                    </th>
                    <th>
                        <a href="?sort=hours&dir={% if sort_by == 'hours' and sort_dir == 'asc' %}desc{% else %}asc{% endif %}{% if max_rank %}&max_rank={{ max_rank }}{% endif %}{% if selected_district %}&district={{ selected_district }}{% endif %}">
                            Hours {% if sort_by == 'hours' %}{% if sort_dir == 'asc' %}↑{% else %}↓{% endif %}{% endif %}
                        </a>
                        <input type="text" class="column-search" data-column="8" placeholder="Search hours...">
                    </th>
                    <th>
                        <a href="?sort=website&dir={% if sort_by == 'website' and sort_dir == 'asc' %}desc{% else %}asc{% endif %}{% if max_rank %}&max_rank={{ max_rank }}{% endif %}{% if selected_district %}&district={{ selected_district }}{% endif %}">
                            Website {% if sort_by == 'website' %}{% if sort_dir == 'asc' %}↑{% else %}↓{% endif %}{% endif %}
                        </a>
                        <input type="text" class="column-search" data-column="9" placeholder="Search websites...">
                    </th>
                    <th>
                        <a href="?sort=created_at&dir={% if sort_by == 'created_at' and sort_dir == 'asc' %}desc{% else %}asc{% endif %}{% if max_rank %}&max_rank={{ max_rank }}{% endif %}{% if selected_district %}&district={{ selected_district }}{% endif %}">
                            Created at {% if sort_by == 'created_at' %}{% if sort_dir == 'asc' %}↑{% else %}↓{% endif %}{% endif %}
                        </a>
                        <input type="text" class="column-search" data-column="10" placeholder="Search dates...">
                    </th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for poi in pois %}
                    <tr>
                        <td {% if not poi.name %}class="empty-cell"{% endif %}>
                            <strong>{{ poi.name|default:"" }}</strong>
                            {% if poi.website %}
                                <br><a href="{{ poi.website }}" target="_blank">Website</a>
                            {% endif %}
                        </td>
                        <td {% if not poi.rank %}class="empty-cell"{% endif %}>{{ poi.rank|default:"" }}</td>
                        <td {% if not poi.sub_category %}class="empty-cell"{% endif %}>{{ poi.sub_category|default:"" }}</td>
                        <td {% if not poi.district %}class="empty-cell"{% endif %}>
                            {{ poi.district.name|default:"Main City" }}
                            {% if poi.district.parent_district %}
                                <br><small>(Part of {{ poi.district.parent_district.name }})</small>
                            {% endif %}
                        </td>
                        <td {% if not poi.description %}class="empty-cell"{% endif %}>{{ poi.description|truncatewords:30|default:"" }}</td>
                        <td {% if not poi.latitude and not poi.longitude %}class="empty-cell"{% endif %}>
                            {% if poi.latitude and poi.longitude %}
                                {{ poi.latitude }}, {{ poi.longitude }}
                            {% endif %}
                        </td>
                        <td {% if not poi.address %}class="empty-cell"{% endif %}>
                            {{ poi.address|default:"" }}
                        </td>
                        <td {% if not poi.phone %}class="empty-cell"{% endif %}>
                            {{ poi.phone|default:"" }}
                        </td>
                        <td {% if not poi.hours %}class="empty-cell"{% endif %}>
                            {{ poi.hours|default:"" }}
                        </td>
                        <td {% if not poi.website %}class="empty-cell"{% endif %}>
                            {% if poi.website %}
                                <a href="{{ poi.website }}" target="_blank">Website</a>
                            {% endif %}
                        </td>
                        <td {% if not poi.created_at %}class="empty-cell"{% endif %}>{{ poi.created_at|default:"" }}</td>
                        <td>
                            <a href="{% url 'poi_history' city.name poi.id %}" class="btn btn-sm btn-info">History</a>
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <script>
        // Fuzzy search function
        function fuzzyMatch(pattern, str) {
            pattern = pattern.toLowerCase();
            str = str.toLowerCase();
            
            let patternIdx = 0;
            let strIdx = 0;
            
            while (patternIdx < pattern.length && strIdx < str.length) {
                if (pattern[patternIdx] === str[strIdx]) {
                    patternIdx++;
                }
                strIdx++;
            }
            
            return patternIdx === pattern.length;
        }

        // Function to handle search
        function handleSearch(event) {
            const searchInput = event.target;
            const searchValue = searchInput.value.trim();
            const columnIndex = parseInt(searchInput.dataset.column);
            const tbody = searchInput.closest('table').querySelector('tbody');
            const rows = tbody.querySelectorAll('tr');
            
            // Get all active searches
            const activeSearches = {};
            document.querySelectorAll('.column-search').forEach(input => {
                const value = input.value.trim();
                if (value) {
                    activeSearches[input.dataset.column] = value;
                }
            });
            
            // Check each row against all active searches
            rows.forEach(row => {
                let showRow = true;
                
                for (const [colIndex, searchValue] of Object.entries(activeSearches)) {
                    const cell = row.children[colIndex];
                    const cellText = cell.textContent.trim();
                    
                    if (!fuzzyMatch(searchValue, cellText)) {
                        showRow = false;
                        break;
                    }
                }
                
                row.classList.toggle('hidden', !showRow);
            });
        }

        // Add event listeners to all search inputs
        document.querySelectorAll('.column-search').forEach(input => {
            input.addEventListener('input', handleSearch);
        });
    </script>
{% else %}
    <p>No points of interest in this category.</p>
{% endif %} 